- name: firewalld is installed
  yum:
      name: firewalld
      state: present

- name: firewalld is running
  service:
      name: firewalld.service
      enabled: yes
      state: started

- name: get firewall state
  firewall_cmd:
      state: get
  register: firewalld_state

- debug:
    msg: "{{firewalld_state}}"

- name: add missing zones
  firewall_cmd_zone:
      name: "{{item}}"
      state: present
  with_items: "{{ firewalld_zone_configs.keys() }}"

- name: remove extra zones
  firewall_cmd_zone:
      name: "{{item}}"
      state: absent
  with_items: "{{ firewalld_state['firewalld']['permanent_zones'].keys() | difference(firewalld_zone_configs.keys()) }}"

- name: reload firewall from permanent
  firewall_cmd:
      state: reload

- name: config zones
  include_tasks: zone.yml
  vars:
      firewalld_zone: "{{item}}"
      firewalld_state: "{{firewalld_state}}"
  with_items:
      - "{{ firewalld_zone_names }}"
